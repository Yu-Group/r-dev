---
title: "Yu Group software series: R"
subtitle: "R dev | simChef + dgpoix | vdocs"
author: "Tiffany Tang and James Duncan"
date: "2022/04/27"
output:
  xaringan::moon_reader:
    self_contained: true
    lib_dir: libs # path to local remark.js library
    css: [xaringan-themer.css, "css/my-style.css"]
    nature:
      highlightStyle: googlecode # solarized-dark
      highlightSpans: true
      countIncrementalSlides: false
      navigation:
        scroll: false
---

```{r xaringan-themer, include=FALSE, warning=FALSE}
xaringanthemer::style_mono_accent(
  base_color = "#00b0da",
  header_font_google = xaringanthemer::google_font("Josefin Sans"),
  text_font_google   = xaringanthemer::google_font("Montserrat", "300", "300i"),
  code_font_google   = xaringanthemer::google_font("Fira Mono")
)
xaringanExtra::use_fit_screen()
```

```{css, echo=FALSE}
pre {
  max-height: 400px;
  overflow-y: auto;
}

pre[class] {
  max-height: 100px;
}

.remark-code, .remark-inline-code  { font-family: 'Ubuntu Mono'; }
a, a > .remark-inline-code { color: rgb(249, 38, 114); }
.remark-slide-scaler { overflow-y: auto; }
```

# Roadmap

### 1. <span style="color:#4285f4">R package development</span>
- *Walkthrough*: creating a toy R package
- Useful tools: documentation, unit testing, GitHub actions

### 2. <span style="color:#4285f4">`simChef`</span> for cooking up simulations in R

<img src="images/simchef_people.png" width="40%" style="margin-left:40px">

### 3. <span style="color:#4285f4">`vdocs`</span> (short for veridical docs)

<img src="images/vdocs_people.png" width="31%" style="margin-left:40px">

*Resources available at: https://github.com/Yu-Group/r-dev 

---

# Why bother with R packages?

- For sharing re-usable code with others

```r
devtools::install_github("Yu-Group/simChef")

library(simChef)
# You can now use functions from simChef!
```

--

- For organizing your code

<center><img src="images/r_pkg_structure.png" width="300"></center>

--

- Lots of helpful tools that are tied to this package structure (e.g., [`usethis`](https://usethis.r-lib.org/), [`devtools`](https://devtools.r-lib.org/), [`roxygen2`](https://roxygen2.r-lib.org/), [`pkgdown`](https://pkgdown.r-lib.org/))

---

# Let's get started with a toy R package

```r
# create package with tidyverse conventions implemented
usethis::create_tidy_package("R.pkg.ex")  
```

--

<br>

This will

- create a new package named `R.pkg.ex`
- apply as many of the tidyverse conventions as possible, 
- issue a few reminders
- activate the new package.

<img src="images/r_tidy_pkg_structure.png" width="200" style="position: absolute; right: 40px; top: 250px">

--

<br><br>

```r
# or alternatively, a more barebones start
usethis::create_package("R.pkg.ex")
```

---

# Writing a reusable R function

All R functions belong in the `R/` directory.

Let's create a file called `R/example_function.R` and add the following to the file:

--

```{r}
remove_constant_columns <- function(X) {
  const_cols <- purrr::map_lgl(X, ~all(duplicated(.x)[-1L]))
  X_cleaned <- X %>%
    dplyr::select(which(!const_cols))
  return(const_cols)
}
```

--

What does this function do?

---

# Documentation with `roxygen2`

```r
#' Remove constant columns in data
#'
#' @description Given some data X, removes all columns in the data that are a
#'   constant value (while ignoring NAs).
#'
#' @param X A data frame.
#'
#' @return A data frame where constant columns have been removed.
#'
#' @examples
#' X <- data.frame(a = c(1, 1, 1), b = c(1, 2, 3))
#' X_cleaned <- remove_constant_columns(X)
#' 
#' @export
remove_constant_columns <- function(X) {
  const_cols <- purrr::map_lgl(X, ~all(duplicated(.x)[-1L]))
  X_cleaned <- X %>%
    dplyr::select(which(!const_cols))
  return(const_cols)
}
```

We can then render the documentation easily via:

```r
devtools::document()  # or equivalently, roxygen2::roxygenise()
```

--

After this, we can see the function documentation via the usual:

```r
? remove_constant_columns
```

<center><img src="images/documentation.png" width="300"></center>

---

# Managing dependencies

Note however that `remove_constant_columns` depends on other packages.

```{r, eval = FALSE}
remove_constant_columns <- function(X) {
  const_cols <- `purrr`::map_lgl(X, ~all(duplicated(.x)[-1L]))
  X_cleaned <- X `%>%`
    `dplyr`::select(which(!const_cols))
  return(const_cols)
}
```

--

The `usethis` package makes it easy to manage these dependencies:

```r
usethis::use_package("purrr")
usethis::use_package("dplyr")
usethis::use_pipe()
```

---

# Additional documentation

### Readme

This is the first thing that people will see on GitHub (and package website).

The `README.Rmd` file has already been initialized by `usethis::create_tidy_package()`. We next need to render the README.Rmd into a README.md via:

```r
devtools::build_readme()
```

--

### Creating vignettes

Vignettes are a great way to teach others how to use your code/package.

To begin creating a vignette, `usethis` provides a nice starter template:

```r
usethis::use_vignette("example_vignette")
```

This initializes a vignette found at `vignettes/example_vignette.Rmd`

---

# Creating a website

So far, we have created an R package with a toy R function, some documentation, and a vignette.

An easy way to organize all this documentation and to improve accessibility is through a package website.

```r
pkgdown::build_site()
```

<iframe src="docs/index.html" width=100% height=60%></iframe>

---

# Other useful commands

To check whether or not the package can be built successfully:

```r
devtools::check()
```

[Note that `devtools::check()` rebuilds all the accompanying documentation, runs all unit tests, and goes through CRAN checks.]

<br>
To quickly load in the package under development and its most recent changes:

```r
devtools::load_all()
```

<br>
To automatically style source code according to the tidyverse style guide:

```r
usethis::use_tidy_style()
```

---

# testthat

Testing is an important part of the data science workflow!
`r emo::ji("paperclips")`[`testthat`](https://testthat.r-lib.org/)  makes it simple.

```{r, eval=FALSE}
hitchhiker <- function(x) {
  return(x + 1)
}

testthat::expect_equal(hitchhiker(41), 42)
testthat::expect_equal(hitchhiker(42), 42)

## Error: hitchhiker(42) not equal to 42.
## 1/1 mismatches
## [1] 43 - 42 == 1
```
Other useful `testthat` verbs:
* `expect_identical` -- test if objects are the same
* `expect_true`, `expect_false`
* `expect_lt`, `expect_gt`
* `expect_error`, `expect_warning`
* `expect_snapshot` -- saves stdout and later compares with this gold standard

---

# testthat

`r emo::ji("file_folder")` `testthat` tests should be in a directory called `tests/testthat/` next to your
project's `R/` directory. (`usethis::use_testthat` can set that up for you.) 

`r emo::ji("page_facing_up")` `testthat` test files should be named like `test-*.R`, e.g. `test-xyz.R`. Again,
there's a `usethis` function to create this: `usethis::use_test("xyz")`.

`r emo::ji("+1")` create one `test-*.R` file for every `*.R` file in `R/`, e.g.,

Here's an example from `simChef`:
```{r, eval=FALSE}
test_that("fit_experiment works properly with future::multicore", {

  # multicore plan isn't supported on windows
  skip_on_os("windows")

  # fit_experiment_fixture() returns sequential and parallel simulation results
  results <- fit_experiment_fixture(future::multicore)

  expect_identical(results[[1]], results[[2]])
})
```

---

# withr

`r emo::ji("paperclips")`[`withr`](https://withr.r-lib.org/index.html) is another helpful package for
writing testing code and much more.

* Prevents unintended side effects (aka, hard to squash `r emo::ji("mosquito")`!): `with_environment()`
* Cleans up temporary state: `with_tempfile()`
* Helps with reproducibility: `with_seed()`
* Can run arbitrary code when exiting a frame in the call stack: `defer()`, `defer_parent()`

---

# withr in simChef

We use `withr` to temporarily set a `future` plan and reset it when the code
inside of `with_plan` finishes.

```{r, eval=FALSE}
set_plan <- function(plan, ...) {
  # get the original plan so we can reset at the end
  old_plan <- future::plan()
  future::plan(plan, ...)
  return(old_plan)
}

reset_plan <- function(plan) {
  future::plan(plan)
}

with_plan <- withr::with_(set_plan, reset_plan)

fit_experiment_fixture <- function(plan) {
  ... # setup code

  parallel <- withr::with_seed( # set the random seed
    seed,
    with_plan( # set the plan
      plan,
      fit_experiment(experiment, n_reps = 10) # get results in parallel
    )
  )
  return(list(parallel, sequential))
}
```

---

# GitHub Actions

 `r emo::ji("paperclips")`[GitHub Actions](https://docs.github.com/en/actions): automated scripts that run
on GitHub's servers when you make changes to a repo.

They help automate:

* testing
* code "linting" (syntax / style checking)
* (documentation) website deployment
* many other repetitive tasks that run when code changes

Here's the `usethis` command: `usethis::use_github_actions("check-standard")`.

---

# Example: Automated grading of STAT 215A lab reports

`r emo::ji("paperclips")`[auto215a](https://github.com/Yu-Group/auto215a/) (private repo)



---

# `Yu-Group` Actions

GitHub Action are a key part of the group's project / software development
workflow, used by:

* `simChef`
* `vdocs`
* `vflow`
* `imodels`
* Many more projects and hopefully yours too!

---

# r-lib GitHub actions

Many of the core R packages we've mentioned are maintained in the
`r emo::ji("paperclips")`[`r-lib`](https://github.com/r-lib) GitHub organization, including:
* `devtools`
* `roxygen2`
* `testthat`
* `pkgdown`
* `usethis`

`r-lib` also maintains a very useful repo with many GitHub Actions scripts that
you can use in your workflows: `r emo::ji("paperclips")`[r-lib/actions](https://github.com/r-lib/actions).

---

# xaringan

We created these slides in `Rmarkdown` via the package `r
emo::ji("paperclips")`[`xaringan`](https://bookdown.org/yihui/rmarkdown/xaringan.html).

How these slides were created:

```{r, eval=FALSE}
install.packages("xaringan")

# download deps for offline viewing of slides
xaringan::summon_remark()

# create an html version of the slides
rmarkdown::render("slides.Rmd")

# push the slides to GitHub pages
# see `?gh_token_help` for info on creating / registering a PAT
# TODO: the repo needs to be public for this to work
usethis::use_github_pages(path = "slides")
```
* `r emo::ji("paperclips")`[xaringanthemer](https://pkg.garrickadenbuie.com/xaringanthemer)
* `r emo::ji("paperclips")`[xaringanExtra](https://pkg.garrickadenbuie.com/xaringanExtra)

---

# Additional resources

* `r emo::ji("paperclips")`["Advanced R" (2nd edition)](https://adv-r.hadley.nz)
* `r emo::ji("paperclips")`["R Packages" (2nd edition)](https://r-pkgs.org/)
* `r emo::ji("paperclips")`["bookdown: Authoring Books and Technical Documents with R Markdown"](https://bookdown.org/yihui/bookdown/)

---

# Automated R Markdown Documentation

**Rapid** and **convenient** reporting of *results*

**Transparent** and **organized** communication of the *simulation design + code*

All in one line of code:

```r
create_rmd(experiment)
```

---

class: no-padding

<iframe src="rmd/linear_regression_output.html" width=100% height=100%></iframe>

---

# vdocs (veridical docs)

### For beautiful and easy documentation of PCS analyses

* Originally motivated by our collaboration with MD Anderson
* There's a need for an interactive guide to walk practitioners through the data science life cycle with a PCS lens.
* **Our aim**: create an interactive *PCS lab notebook*, analogous to a scientific lab notebook

---

class: no-padding

<iframe src="rmd/TCGA-BRCA-Example.html" width=100% height=100%></iframe>

---

# Try it for yourself!

<div style="width: 50%; float: left; text-align: center">
<h3 style="text-align: center; margin-top: 30px; padding-bottom: 10px;">simChef</h3>
for realistic, reliable, reproducible, and responsible simulations
<br>
<a href="https://github.com/Yu-Group/simChef">https://github.com/Yu-Group/simChef</a>
</div>

<div style="margin-left:50%; text-align: center">

<h3 style="text-align: center; padding-top: 30px; padding-bottom: 10px;">vdocs</h3>
for beautiful and easy documentation of <br>PCS analyses
<br>
<a href="https://github.com/Yu-Group/vdocs">https://github.com/Yu-Group/vdocs</a>
</div>

<br>

*For development of your own Rmd-generated html documents, check out: https://github.com/Yu-Group/vthemes 

<br>

<h2 style="text-align: center;">Let us know what you think!</h2>

---
